name: Build Android APK (Fnal fFix)
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: 1. Install Dependencies & Capacitor
        run: |
          npm install
          npm install @capacitor/core @capacitor/cli @capacitor/android

      - name: 2. Build Web Project
        run: npm run build

      - name: 3. Initialize Android Project
        run: |
          npx cap init "Base44App" "com.base44.app" --web-dir dist
          npx cap add android || true
          npx cap sync android

      - name: 4. Fix Kotlin Duplicates (The Magic Step) ðŸª„
        run: |
          cd android
          
          # Cette commande force Gradle Ã  utiliser une seule version de Kotlin pour tout le monde
          # On ajoute ce bloc Ã  la fin du fichier build.gradle principal
          cat <<EOF >> build.gradle
          
          allprojects {
              configurations.all {
                  resolutionStrategy.eachDependency { details ->
                      if (details.requested.group == 'org.jetbrains.kotlin' && details.requested.name.startsWith('kotlin-stdlib')) {
                          details.useVersion '1.9.10'
                      }
                  }
              }
          }
          EOF
          
          # On met aussi Ã  jour la variable de version si elle existe
          if [ -f "variables.gradle" ]; then
            sed -i 's/kotlin_version = .*/kotlin_version = "1.9.10"/' variables.gradle
          fi

      - name: 5. Build APK (Debug Version)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: mon-app-android
          path: android/app/build/outputs/apk/debug/app-debug.apk
